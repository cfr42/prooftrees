% $Id: tag-tableau-e3.tex 11140 2025-08-24 16:36:48Z cfrees $
\DocumentMetadata{
 tagging=on,
 lang=en-GB,
 pdfversion=2.0,
 pdfstandard=ua-2,
 uncompress,
}
\tagpdfsetup{
  math/mathml/structelem,
}
\documentclass{article}
\usepackage{memoize}
\mmzset{prefix=memos/,}
\usepackage[tableaux]{prooftrees}
\usepackage{turnstile}
\usepackage{unicode-math}
\makeatletter
\newcount\prooftrees@tableau@id
\newtoks\prooftrees@tableau@toks
\ExplSyntaxOn
\tl_new:N \l__tableau_toks_tl
\cs_new_eq:NN \__tableau_property_ref_orig:nn \property_ref:nn
\cs_generate_variant:Nn \__tableau_property_ref_orig:nn {ee}
\cs_new_nopar:Npn \__tableau_pgftikz_tag_bbox:nnn #1#2#3
{
  \__tableau_pgftikz_tag_bbox_aux:eenn
  {
    \__tableau_property_ref_orig:ee {#1}{xpos}
  }
  {
    \__tableau_property_ref_orig:ee {#1}{ypos}
  }
  {#2}{#3}
}
\cs_generate_variant:Nn \__tableau_pgftikz_tag_bbox:nnn {enn,eVV}
\cs_new_nopar:Npn \__tableau_pgftikz_tag_bbox_aux:nnnn #1#2#3#4
{
  \dim_to_decimal_in_bp:n {#1sp}
  \c_space_tl
  \dim_to_decimal_in_bp:n {#2sp}
  \c_space_tl
  \dim_to_decimal_in_bp:n {#1sp+#3}
  \c_space_tl
  \dim_to_decimal_in_bp:n {#2sp+#4}
}
\cs_generate_variant:Nn \__tableau_pgftikz_tag_bbox_aux:nnnn {eenn,eeVV}
\socket_new:nn {tableaux/tagsupport/tableau/init}{0}
\socket_new:nn {tableaux/tagsupport/tableau}{2}
\socket_new:nn {tableaux/tagsupport/tableau/mmzx}{2}
\socket_new_plug:nnn {tableaux/tagsupport/tableau/init}{tag}
{
  % can't use noop due to collection of mcs even if tagging suspended;
  % artifact gets rid of these
  % I think some combination of:
  %   \tag_suspend:n {\tableau}
  %   \tag_resume:n {\tableau}
  %   \luamml_ignore:
  % should work, but I have no idea how to get it right
  \socket_assign_plug:nn {tagsupport/tikz/picture/begin}{artifact}
  \socket_assign_plug:nn {tagsupport/tikz/picture/end}{artifact}
  % \tag_suspend:n {\tableau}
  % \luamml_ignore:
}
\socket_new_plug:nnn {tableaux/tagsupport/tableau}{alt}
{
  \tag_mc_end_push:
  \tag_struct_begin:n
  {
    tag=Figure,
    alt=\l__tableau_toks_tl
  }
  \cs_new:cpe {prooftrees@tableau@mark@pos@\the\prooftrees@tableau@id}
  {
    \__tableau_pgftikz_tag_bbox:enn {prooftrees-tableau-id\the\prooftrees@tableau@id}
    {#1}{#2}
  }
  \tag_struct_gput:ene
  {\tag_get:n {struct_num}}
  {attribute}
  {
    /O /Layout /BBox~
    [
      \use:c
      {prooftrees@tableau@mark@pos@\the\prooftrees@tableau@id}
    ]
  }
  \tag_struct_end:
  \tag_mc_begin_pop:n{}
}
\socket_new_plug:nnn {tableaux/tagsupport/tableau/mmzx}{alt}
{
  \gtoksapp\mmzCCMemo{
    % TBR!
    \makeatletter
    \global\advance\prooftrees@tableau@id~by~1\relax
    % TBR!
    \ExplSyntaxOn
    \tex_savepos:D
    \property_record:ee {prooftrees-tableau-id\the\prooftrees@tableau@id}
    {xpos,ypos}
    \tex_savepos:D
    \tag_mc_end_push:
    % TBR!
    \ExplSyntaxOff
    \tagstructbegin
  }
  \xtoksapp\mmzCCMemo{
    \c_left_brace_str
    tag=Figure,
    alt=
    \c_left_brace_str
  }
  \exp_args:NNV \gtoksapp\mmzCCMemo \l__tableau_toks_tl
  \xtoksapp\mmzCCMemo{
    \c_right_brace_str
    \c_right_brace_str
  }
  \gtoksapp\mmzCCMemo{
    % TBR!
    \ExplSyntaxOn
    \cs_new:cpe {prooftrees@tableau@mark@pos@\the\prooftrees@tableau@id}
    {
      \__tableau_pgftikz_tag_bbox:enn {prooftrees-tableau-id\the\prooftrees@tableau@id}
      {#1}{#2}
    }
    \tag_struct_gput:ene
    {\tag_get:n {struct_num}}
    {attribute}
    {
      /O /Layout /BBox~
      [
        \use:c
        {prooftrees@tableau@mark@pos@\the\prooftrees@tableau@id}
      ]
    }
    \tag_struct_end:
    \tag_mc_begin_pop:n{}
    % TBR!
    \ExplSyntaxOff
    % TBR!
    \makeatother
  }
}
\cs_new_nopar:Npn \__tableau_ttableau_init: 
{
  \tag_if_active:T{
    \forestset{tag=1}
    \global\prooftrees@tableau@toks{}
    \socket_assign_plug:nn {tableaux/tagsupport/tableau/init}{tag}
    \socket_use:n {tableaux/tagsupport/tableau/init}
    \def\pgfsys@begin@text{}
    \def\pgfsys@end@text{}
  }{\forestset{tag=0}}
}
\cs_new_eq:NN \prooftrees@ttableau@init \__tableau_ttableau_init:
\cs_new_nopar:Npn \__tableau_ttableau:nnn #1#2#3
{
  % \tag_resume:n {\tableau}
  \tex_savepos:D
  \property_record:ee {prooftrees-tableau-id\the\prooftrees@tableau@id}
  {xpos,ypos}
  \tex_savepos:D
  \tl_set:No \l__tableau_toks_tl {\the\prooftrees@tableau@toks}
  \socket_assign_plug:nn {tableaux/tagsupport/tableau}{#1}
  \ifmemoizing
    \socket_assign_plug:nn {tableaux/tagsupport/tableau/mmzx}{#1}
  \fi
  \socket_use:nnn {tableaux/tagsupport/tableau} {#2}{#3}
  \socket_use:nnn {tableaux/tagsupport/tableau/mmzx} {#2}{#3}
  % \tag_suspend:n {\tableau}
}
\cs_new_eq:NN \prooftrees@ttableau \__tableau_ttableau:nnn
\cs_new_nopar:Npn \__tableau_ttableau_after:
{
  % \tag_resume:n {\tableau}
}
\cs_new_eq:NN \prooftrees@ttableau@after \__tableau_ttableau_after:
\hook_gput_code:nnn {begindocument} {.}
{
  \@ifpackageloaded{memoize}{
    \mmzset{direct~ccmemo~input=true,}
  }{\newif\ifmemoizing\memoizingfalse}
}
\ExplSyntaxOff
\forestset{%
  declare boolean register={tag},
  tag=0,
  declare toks register={plug},
  declare toks register={tag check with},
  tag check with={checked},
  declare toks register={tag close with},
  tag close with={closed},
  declare toks register={tag subs with},
  tag subs with={substituted},
  declare keylist={tableau make tags}{},
  declare keylist={tableau get tags}{},
  declare keylist={tableau tag}{},
  declare keylist={tableau tag after}{},
  declare toks={ttoks}{},
  toksapp/.style={%
    TeX={%
      \toksapp\prooftrees@tableau@toks{#1}%
    },
  },
  define long step={proof tree every wff}{}{%
    unique={name=proof statement,proof tree wffs}%
  },
  tableau get tags processing order=proof tree every wff,
  alt/.style={%
    pick up tag/.style={%
      toksapp/.option=ttoks,
      toksapp={\ },
    },
    plug=alt,
  },
  alt,
  ttableau/.style={%
    if={>R{tag}}{%
      tableau make tags={%
        for name={proof statement}{%
          if content={}{}{%
            ttoks/.process={Ow{content}{To prove:\ \ensuremath{##1}}},
          },
        },
        for unique={proof tree wffs}{%
          if proof tree rhifo={
            if line numbering={%
              ttoks+/.option=proof tree proof line no,
              ttoks+={\ },
            }{},
            ttoks+/.process={Ow{content}{\ensuremath{##1}}},
            if justifications={%
              ttoks+/.process={Ow+pw {proof tree proof line no}{O{!{name=just ##1}.content}}{\ ##1\ }},
            }{},
          }{%
            if proof tree crefs={}{}{%
              !uu.ttoks+/.process={ORw2{content}{tag close with}{\ ##2 ##1\ }},
            },
          },
        },
        for proof tree every wff={%
          tableau get tags={%
            pick up tag/.option=ttoks,
          },
        },
      },
      tableau tag={%
        tempdima/.max={>OOw2+d{x}{max x}{##1+##2}}{tree},
        tempdima-/.min={>OOw2+d{x}{min x}{##1+##2}}{tree},
        tempdimb/.max={>OOw2+d{y}{max y}{##1+##2}}{tree},
        tempdimb-/.min={>OOw2+d{y}{min y}{##1+##2}}{tree},
        TeX/.process={%
          RRRw3{plug}{tempdima}{tempdimb}{\prooftrees@ttableau{##1}{##2}{##3}}%
        },
      },
      tableau tag after={%
        TeX=\prooftrees@ttableau@after,
      },
    }{},
  },
}
\bracketset{action character=@}
\RenewDocumentEnvironment{tableau}{ m +b }{% 
  \global\advance\prooftrees@tableau@id by 1
  \prooftrees@ttableau@init
  \forest
    (%
      stages={% 
        for root'={% 
          process keylist register=default preamble,
          process keylist register=preamble,
        },
        process keylist=given options,
        process keylist=before typesetting nodes,
        process keylist=proof tree ffurf,
        process keylist=proof tree symud awto,
        typeset nodes stage,
        process keylist=before packing,
        pack stage,
        process keylist=before computing xy,
        compute xy stage,
        process keylist=proof tree creu nodiadau,
        process keylist=proof tree nodiadau,
        process keylist=before drawing tree,
        process keylist=tableau make tags,
        process keylist=tableau get tags,
        process keylist=tableau tag,
        draw tree stage,
        process keylist=tableau tag after,
      },
    )%
    proof tree,
    ttableau,
    #1,
    [, name=proof statement @#2]%
  \endforest
}{}
\makeatother
\newcommand*{\lif}{\ensuremath{\mathbin{\rightarrow}}}
\title{t}
\begin{document}
\begin{tableau}{%
  to prove=\sststile{}{}p\vee\lnot p,
}
  [\lnot(p\vee\lnot p),just=$\lnot$ conc
    [\lnot p,just=$\vee$E:!u,
      [\lnot\lnot p,just=$\vee$E:!uu,close={:!u,!c},]
    ]
  ]
\end{tableau}
\begin{tableau}
  {
    to prove={\{P \vee (Q \vee \lnot R), P \lif
      \lnot R, Q \lif \lnot R\} \sststile{}{} \lnot
    R}
  }
  [P \vee (Q \vee \lnot R), just=Ass, checked
    [P \lif \lnot R, just=Ass, checked
      [Q \lif \lnot R, just=Ass, checked, name=last premise
        [\lnot\lnot R, just={$\lnot$ Conc},
          name=not conc
          [P, just={$\vee$ Elim:!uuuu}
            [\lnot P, close={:!u,!c}]
            [\lnot R, close={:not conc,!c},
          just={$\lif$ Elim:!uuuu}]]
          [Q \vee \lnot R
            [Q, move by=1
              [\lnot Q, close={:!u,!c}]
              [\lnot R, close={:not conc,!c},
            just={$\lif$ Elim:last premise}]]
            [\lnot R, close={:not conc,!c},
  move by=1, just={$\vee$ Elim:!u}]]]]]]
\end{tableau}
\end{document}

